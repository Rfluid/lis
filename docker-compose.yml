services:
    lis:
        image: lis:latest
        env_file:
            - .env
        environment:
            POSTGRES_URI: postgresql://postgres:postgres@postgres:5432/postgres?sslmode=disable
            MILVUS_URI: http://milvus:19530 # <<<<<< explicit overwrite for lis service
            DATA_DIR: /app/data
            PROMPTS_DIR: /app/prompts
            API_URL: http://localhost:8000
        ports:
            - "8000:8000" # Backend
            - "8501:8501" # Frontend
        volumes:
            - ./data:/app/data
            - ./prompts:/app/prompts
        networks:
            - net
        depends_on:
            - postgres
            - milvus # <<< lis will wait for milvus too

    postgres:
        image: postgres:15
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: postgres
        networks:
            - net

    etcd:
        image: quay.io/coreos/etcd:v3.5.0
        environment:
            - ETCD_AUTO_COMPACTION_MODE=revision
            - ETCD_AUTO_COMPACTION_RETENTION=1000
            - ETCD_QUOTA_BACKEND_BYTES=4294967296
        command: etcd -advertise-client-urls=http://0.0.0.0:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
        networks:
            - net

    minio:
        image: minio/minio:RELEASE.2020-12-03T00-03-10Z
        environment:
            MINIO_ACCESS_KEY: minioadmin
            MINIO_SECRET_KEY: minioadmin
        command: minio server /minio_data
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 30s
            timeout: 20s
            retries: 3
        networks:
            - net

    milvus:
        image: milvusdb/milvus:v2.3.9
        command: ["milvus", "run", "standalone"]
        environment:
            ETCD_ENDPOINTS: etcd:2379
            MINIO_ADDRESS: minio:9000
        ports:
            - "19530:19530"
            - "19121:19121" # Optional, REST API
        depends_on:
            - etcd
            - minio
        networks:
            - net
        volumes:
            - lis_milvus:/var/lib/milvus

volumes:
    lis_milvus:

networks:
    net:
